<html>
  <head>
    <title>Searchable CSV</title>

    <script src="/static/d3.min.js" charset="utf-8"></script>
    <script src="/static/jquery-2.2.0.min.js" charset="utf-8"></script>

    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <script src="/static/bootstrap.min.js" ></script>

    <link rel="stylesheet" href="/static/jquery.dataTables.min.css">
    <script src="/static/jquery.dataTables.min.js" charset="utf-8"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
      b {font-size: 20px;}
    </style>

  </head>
  <body>
    <div class="container-fluid" style="margin-top:15px;">
      <div class="row">

        <div class="col-md-2">
          <div class="panel panel-default">
            <div class="panel-heading"><b>Filter</b></div>
            <div class="panel-body"><button class="btn btn-success btn-block" type="button" onclick="showTable(csv)">Show All</button></div>
            <!-- List group -->
            <ul class="list-group" id="options"></ul>
          </div>
        </div>

        <div class="col-md-10">
          <div class="table-responsive" id='table'></div>
        </div>

      </div>
    </div>
  </body>

  <script>
    function FilteAndShow(item){
      var category = item.dataset['key']
      var value = item.text
      showTable(csv.filter(function(d){return d[category] == value}))
    }

    function generateFilter(option){
      var Keys = d3.keys(option);
      for (var x=0;x<Keys.length;x++){
        var Key = Keys[x]
        var Items = option[Key].map(function(d){return '<li><a href="#" data-key="'+Key+'" onclick="FilteAndShow(this)">'+d+'</a></li>'}).join('')
        var output = '<li class="list-group-item"><div class="btn-group btn-block"><button type="button" class="btn btn-default btn-block dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> '+Key+' <span class="caret"></span> </button> <ul class="dropdown-menu"> '+Items+' </ul> </div></li>'
        $('#options').append(output)
      }
    }

    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function getSelectionForCategorizedItem(csv,categorizedItem){
      var key = d3.keys(csv[0]);
      var categorizedItem = categorizedItem.map(function(d){return key[d]})
      var option = {}
      for (var x=0;x < categorizedItem.length;x++){
        option[categorizedItem[x]] = d3.set(csv.map(function(item){return item[categorizedItem[x]]})).values()
      }
      return option
    }

    function showTable(data){
      $('#table').html('<table class="table table-striped table-hover"></table>')
      var columns = d3.keys(data[0]).map(function(item){return {'title':item}})
      var data = d3.csv.parseRows(d3.csv.format(data)).slice(1)
      console.log(columns,data)
      $('#table > .table').DataTable( {
        data: data,
        columns: columns
      } );
    }

    $(document).ready(function(){
      var source = getParameterByName('source');
      var keyRow = getParameterByName('keyrow');
      categorizedItem = getParameterByName('cColumn');
      //If keyrow is not specified, then equal to 0.
      if (!keyRow) {keyRow=0;}
      if (categorizedItem) {categorizedItem = categorizedItem.split(',').map(function(d){return parseInt(d)})}
      console.log('Parameter:',source,keyRow,categorizedItem)
      if (source) {
        d3.text("https://crossorigin.me/"+source, function(text) {
          csv = d3.csv.parse(d3.csv.formatRows(d3.csv.parseRows(text).slice(keyRow)));
          var option = getSelectionForCategorizedItem(csv,categorizedItem)
          showTable(csv)
          generateFilter(option)
        });
      }
      else{
        console.log('No Data')
      }
    })

  </script>
</html>
