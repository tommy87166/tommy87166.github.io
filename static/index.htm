<html>
  <head>
    <title>成績輸入小幫手</title>
    <script src="/static/d3.min.js" charset="utf-8"></script>
    <script src="/static/jquery-2.2.0.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <script src="/static/bootstrap.min.js" ></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
    .main {display: flex;justify-content: center;align-items: center;width: 100%;height: 100%;flex-direction:column;}
    .opendata {margin: 0px;min-width: 200px;}
    .inputdata {margin: 0px;min-width: 200px;margin-left: 5px;margin-right: 5px;display: none;}
    .export {margin: 0px;min-width: 200px;margin-left: 5px;margin-right: 5px;display: none;}
    .well {margin-bottom: 0px;margin-top: 20px;display: none;}
    </style>

  </head>
  <body>
    <div class="container-fluid">

        <div class="main">

          <div class="panel panel-default opendata">
            <div class="panel-body"><input onchange="loadfile()" type="file" id="file"></div>
            <div class="panel-footer"><button onclick="OKfile()" class="btn btn-success btn-block" type="button">確定</button></div>
          </div>
          <div id="preview" class="well">sss</div>

          <div class="panel panel-default inputdata">
            <div class="panel-body"><input class="form-control" oninput="inputkey()" type="text" id="inputkey" placeholder="搜尋"></div>
            <ul class="list-group" id="candidate"></ul>
          </div>

          <div class="panel panel-default inputdata">
            <div class="panel-body"><input class="form-control" type="integer" id="inputscore" placeholder="成績"></div>
          </div>

          <div class="panel panel-default export">
            <div class="panel-body"><button onclick="output()" class="btn btn-success btn-block" type="button">輸出</button></div>
          </div>

        </div>


    </div>
  </body>

  <script>
    function loadfile(){
      //Read and Preview File
      var reader = new FileReader();
      reader.onload = function(data){
        source = d3.csv.parse(data.target.result)
        $("#preview").html(JSON.stringify(source))
      }
      reader.readAsText($("#file")[0].files[0])
      $("#preview").fadeIn()
    }
    function OKfile(){
      $(".opendata").fadeOut(function(){
        $(".opendata").remove()
        $("#preview").fadeOut(function(){
          $("#preview").remove()
          $(".main").css("flex-direction","row")
          $(".inputdata").fadeIn()
        })
      })
    }

    function inputkey(){
      //Clear Input Score
      $('#inputscore').val("")
      //Get Input
      var key = $("#inputkey").val()
      var filtered = source.filter(function(x){return x["#key"].includes(key)})
      //Fill candidate
      $("#candidate").empty()
      if (filtered.length == 1){
        $("#candidate").append('<li class="list-group-item active" data-key="'+filtered[0]["#key"]+'">'+JSON.stringify(filtered[0])+'</li>')
        //Get Existed Score
        var key = $('#candidate > .active')[0].dataset['key']
        if (key in resultScore){$('#inputscore').val(resultScore[key])}
      }
      else {$("#candidate").append('<li class="list-group-item">有 '+filtered.length+' 個選項，繼續輸入！</li>')}
    }

    //Change Input with Enter
    $("#inputkey").keyup(function (e) {
      if (e.keyCode == 13) {
        if ($('#candidate > .active').length == 1 ){
          $("#inputscore")[0].focus()
        }
      }
    });

    $("#inputscore").keyup(function (e) {
      if (e.keyCode == 13) {
        //Store
        var key = $('#candidate > .active')[0].dataset['key']
        var score = $('#inputscore').val()
        if (resultOrder.indexOf(key) == -1){resultOrder.push(key);}
        resultScore[key] = score;
        //Clear
        $("#candidate").empty()
        $('#inputkey').val("")
        $('#inputscore').val("")
        //Change Focus
        $("#inputkey")[0].focus()
        //Show on Console
        for (var i = 0; i < resultOrder.length; i++) {
          console.log(i+1,resultOrder[i],resultScore[resultOrder[i]])
        }
        //Check If Finish
        if (Object.keys(resultScore).length == source.length){$(".export").slideDown()}
        else {$(".export").slideUp()}

      }
    });

    function output(){
      $("body").empty()
      $("body").append("key,score<br>")
      for (var i = 0; i < resultOrder.length; i++) {
          $("body").append(resultOrder[i]+","+resultScore[resultOrder[i]]+"<br>")
        }
      }

    resultOrder = []
    resultScore = {}

  </script>


</html>
